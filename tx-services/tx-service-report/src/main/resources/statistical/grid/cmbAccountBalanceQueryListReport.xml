<?xml version="1.0" encoding="UTF-8" ?>
		<report
				xmlns="http://wtms.com/xml/statistical-1.0.xsd"
                xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                xsi:schemaLocation="http://wtms.com/xml/statistical-1.0.xsd"
		code="cmbAccountBalanceQueryListReport" type="pagedListGrid"  name="招商银行余额查询"
		>


<!-- 设计考虑根据report可以生成对应的页面：考虑技术：freemarker -->
<!-- sql解析：利用Mybatis进行支撑：该支撑后期我来支撑，需要升级Mybatis -> 3.4 版本，现在tx-parent有兼容问题 -->
<!-- report.type 要求能够通过实现接口进行扩展 -->
<!-- report.conditions.item.type 要求能够通过实现接口进行扩展 -->
<!-- report.views.item.type 要求能够通过实现接口进行扩展 -->

<!-- code:必填：值不能重复 -->
<!-- type:非必填：默认值为pagedListGrid 其他支持类型：listGrid|pagedListGrid 要求该类型支撑线性扩展1111 -->
<!-- name:非必填：如果为空取code值 -->

	<!-- 页面附加的javascript:非必填 -->
	<script></script>

	<!-- cols：非必填： 默认为2 如果条件项小于3，则自动修改对应值，如果为3的倍数，则为3，如果为2的倍数则为2 -->
	<conditions>
		<!-- type:非必填： 默认为input 可选值:input|input_datetime|input_date  :预制类型要求能够扩展，如果没有预制的允许通过js等进行支撑 -->
		<!-- class:非必填：默认为text -->
		<!-- default:非必填：默认填写值 -->
		<!-- readOnly:非必填：默认为false -->
		<item id="userName" name="姓名/机构名称" type="input" value=""/>
		<item id="loginName" name="交易账户" type="input" value=""/>
		<item id="queryDate" name="查询日期" type="input"  value="" readOnly="true" onClick="WdatePicker({readOnly:true,dateFmt:'yyyy-MM-dd' ,minDate:'2017-02-27',maxDate:'%y-%M-%d'})"/>
	</conditions>
	
	<!-- fitColumns:非必填，默认值为false -->
	<views fitColumns="false" sqlMapperId="queryCMBAccountBalanceList" >
		<!-- formatter: -->
		<!-- width:非必填：默认值为 150 -->
		<!-- hidden:非必填：false -->
		<!-- frozen:非必填：false -->
		<item column="userName" name="客户名字"/>
		<item column="loginName" name="交易账户" />
		<item column="accountCode" name="虚拟账号" ></item>
        <item column="accountSum" name="资金余额" statisticalType="sum" type="number"/>
	</views>

	<sqlMappers >
		<!-- datebaseId:非必填: 如果不填则databaseId为默认值 -->
		<sqlMapper id="queryCMBAccountBalanceList" >
			SELECT
			ttri.id,
			afterAmount as accountSum,
			tcai.`code` as accountCode,
			tcai.accountName,
			tc.loginName,
			tc.mobilePhoneNumber,
			tc.userName
			FROM
			cla_ttr_amount_cr_item ttri
			JOIN cla_client_account_item tcai ON ttri.clientAccountItemId = tcai.id
			JOIN cl_client_info tc ON ttri.clientId = tc.id
			JOIN (
			SELECT
			SUBSTR(
			max(
			CONCAT(
			date_format(createdate, '%Y%m%d%H%i%s'),
			id
			)
			),
			15

			) AS id
			FROM
			cla_ttr_amount_cr_item
			WHERE
			1 = 1
			<if test="@com.tx.core.util.OgnlUtils@isNotEmpty(queryDate)">
				<![CDATA[ AND createdate <= DATE_ADD(#{queryDate},INTERVAL 1 DAY)]]>
			</if>
			GROUP BY  clientId
			) m ON m.id = ttri.id
			WHERE
			ttri.paymentChannel = 'CMB'
					<if test="@com.tx.core.util.OgnlUtils@isNotEmpty(userName)">
						<![CDATA[ AND tc.userName like concat('%', #{userName} ,'%' )]]>
					</if>
					<if test="@com.tx.core.util.OgnlUtils@isNotEmpty(loginName)">
						<![CDATA[ AND tc.loginName = #{loginName}]]>
					</if>
					ORDER BY accountSum DESC
		</sqlMapper>

	</sqlMappers>
	

</report>


