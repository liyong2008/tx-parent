<?xml version="1.0" encoding="UTF-8" ?>
<report
        xmlns="http://wtms.com/xml/statistical-1.0.xsd"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://wtms.com/xml/statistical-1.0.xsd"
        code="investProjectReport" type="pagedListGrid" name="投资报表"
>

    <!-- 页面附加的javascript:非必填 -->
    <script>
        function timeUnitFn(cellvalue,options,index){
                if($.ObjectUtils.isEmpty(cellvalue)){
                return cellvalue;
                }
                var time=options['time'];
                var unitName ="";
                if(cellvalue =='DAY'){
                    unitName = "天"
                }else  if(cellvalue =='MONTH'){
                    unitName = "月";
                    }else  if(cellvalue =='YEAR'){
                    unitName = "年"
                    }
                return time +" "+ unitName;
        }



        function showInvestProjectDetail(value,index){
          var row =  grid.datagrid('getSelected')
            var url =	$.formatString(_contextPath+"/investProject/toInvestProjectTabs.action?status=INVEST_EFFICTIVE&#38;investProjectId={0}",row.investProjectId);
            $.triggerge("addOrSelectTab", {
            title : '[投资项目:]'+value,
            href : url
            });
        }


        function settledExpire(value,row,index){
            var text = value;
            if(!$.ObjectUtils.isEmpty(value)){
                var investProjectId = row.investProjectId;
                var now = new Date();

                if(now>row.nextSettleDate &#38;&#38; row["status"]=="AC"){
                    text= $.formatString('<span style="color:red;">{0}</span>',value  );
                }
                 }
                return text;

            }



    </script>

    <!-- cols：非必填： 默认为2 如果条件项小于3，则自动修改对应值，如果为3的倍数，则为3，如果为2的倍数则为2 -->
    <conditions cols="4">
        <item id="originalVoucherCode" name="仓单原始凭证" value="" type="input"/>
        <item id="originalVoucherCodeitem" name="仓单子项凭证" value="" type="input"/>
        <item id="investProjectNumber" name="项目编号" value="" type="input"/>
        <item id="status" name="项目状态" value="" type="select" enumClass="com.tx.wtms.invest.model.InvestProjectStatusEnum" items="{:全部}"
        			  labelName="name"/>
		<item cssClass="Wdate" name="生效开始时间" id="minEffectiveDate" type="input_date"  cssStyle="width:38%"/>
		<item cssClass="Wdate" name="生效结束时间"  type="input_date"  id="maxEffectiveDate" cssStyle="width:38%"/>
		<item cssClass="Wdate" name="到期开始时间" id="minExpiredDate" type="input_date" cssStyle="width:38%"/>
		<item cssClass="Wdate" name="到期结束时间"  type="input_date" id="maxExpiredDate" cssStyle="width:38%"/>

    </conditions>

    <!-- fitColumns:非必填，默认值为false -->
    <views fitColumns="false" sqlMapperId="queryPageList"  >
        <item column="investProjectNumber" name="项目编号" type="alink" refValue="showInvestProjectDetail" frozen="true"/>
        <item column="productName" name="仓单品名" frozen="true" />
        <item column="originalVoucherCode" name="仓单原始凭证" frozen="true" />
        <item column="originalVoucherCodeitem" name="仓单子项原始凭证"   frozen="true"/>
        <item column="userName" name="融资人"   frozen="true"/>
        <item column="status" name="项目状态"   frozen="true"
              type="enum"  enumClass="com.tx.wtms.invest.model.InvestProjectStatusEnum" refValue="name"/>
        <item column="investCnt" name="投资人数"   frozen="true" statisticalType="sum"/>
        <item column="investAmount" name="投资总金额"   type="number" statisticalType="sum"/>

        <item column="ids" name="投资账户ID列表" />

        <item column="totalAmount" name="项目总金额" type="number"  statisticalType="sum" />

        <item column="number" name="数量"/>
        <!--<item column="measurementinfoname" name="度量单位"  />-->
        <item column="unitPrice" name="单价" type="number"/>

        <item column="investprojectname" name="项目名称"/>
        <item column="amount" name="项目金额" type="money" />
        <item column="timeUnit" name="期限" formatterFun="timeUnitFn"/>
        <item column="effectiveDate" name="生效日期" type="date"/>
        <item column="expiredDate" name="到期日期" type="date"/>
        <item column="repayType" name="回购方式" type="enum" enumClass="com.tx.component.basicdata.model.RepayTypeEnum" refValue="name" />

    </views>

    <sqlMappers>
        <!--/*-->
        <!--字段	仓单品名	仓单原始凭证	仓单子项原始凭证	仓单发行人	数量	度量单位	单价	总金额-->
        <!--项目名称	项目编号	是否回购	项目金额	期限	生效日期	到期日期	回购方式-->
        <!--购买客户名称	交易账户	购买金额	总期数	当前期数	已结算期数	应收金额	应收本金	应收收入-->
        <!--*/-->
        <!-- datebaseId:非必填: 如果不填则databaseId为默认值 -->
        <sqlMapper id="queryPageList" datasourceId="">
            SELECT
            	p.id,
            	p.id as investProjectId,
                m.ids,
            	m.investCnt,
            	m.investAmount,
            	p.`status`,
            	twr.productName,
            	twr.number,
            	twr.unitPrice,
            	twr.totalAmount,
            	twr.originalVoucherCode,
            	twri.originalVoucherCode AS originalVoucherCodeitem,
            	p. NAME AS investprojectname,
            	p.investProjectNumber,
            	p.amount,
            	p.repayType,
            	p.effectiveDate,
            	p.expiredDate,
            	p.timeUnit,
            	p.time,
                c.userName
            FROM
            	inv_invest_project p
            left join cl_client_info c on p.clientinfoId = c.id
            LEFT JOIN wr_warehouse_receipt_item twri ON p.refId = twri.id
            LEFT JOIN wr_warehouse_receipt twr ON twri.warehouseReceiptId = twr.id
            LEFT JOIN wr_warehouse tw ON twr.WAREHOUSEID = tw.id
            LEFT JOIN (
            	SELECT
            		t.investProjectId,
            		count(1) AS investCnt,
            		sum(investAmount) AS investAmount,
                    group_concat(t.id) as ids
            	FROM
            		IA_INVEST_ACCOUNT_ITEM t
            	GROUP BY
            		t.investProjectId
            ) m ON p.id = m.investProjectId

            WHERE 1 = 1
            <if test="@com.tx.core.util.OgnlUtils@isNotEmpty(originalVoucherCode)">
                <![CDATA[ AND twr.originalVoucherCode = #{originalVoucherCode,jdbcType=VARCHAR} ]]>
            </if>
            <if test="@com.tx.core.util.OgnlUtils@isNotEmpty(originalVoucherCodeitem)">
                <![CDATA[ AND twri.originalVoucherCode = #{originalVoucherCodeitem,jdbcType=VARCHAR} ]]>
            </if>
            <if test="@com.tx.core.util.OgnlUtils@isNotEmpty(investProjectNumber)">
                <![CDATA[ AND p.investProjectNumber = #{investProjectNumber,jdbcType=VARCHAR} ]]>
            </if>
            <if test="@com.tx.core.util.OgnlUtils@isNotEmpty(status)">
                <![CDATA[ AND p.status = #{status,jdbcType=VARCHAR} ]]>
            </if>
            
            <if test="@com.tx.core.util.OgnlUtils@isNotEmpty(maxEffectiveDate)">
				<![CDATA[ AND p.effectiveDate <  DATE_ADD(#{maxEffectiveDate},INTERVAL 1 DAY)  ]]>
			</if>
			<if test="@com.tx.core.util.OgnlUtils@isNotEmpty(minEffectiveDate)">
				<![CDATA[ AND p.effectiveDate >= #{minEffectiveDate,jdbcType=TIMESTAMP} ]]>
			</if>
			<if test="@com.tx.core.util.OgnlUtils@isNotEmpty(maxExpiredDate)">
				<![CDATA[ AND p.expiredDate <  DATE_ADD(#{maxExpiredDate},INTERVAL 1 DAY)  ]]>
			</if>
			<if test="@com.tx.core.util.OgnlUtils@isNotEmpty(minExpiredDate)">
				<![CDATA[ AND p.expiredDate >= #{minExpiredDate,jdbcType=TIMESTAMP} ]]>
			</if>

            <choose>
            <when test="@com.tx.core.util.OgnlUtils@isNotEmpty(orderSql)">
                ORDER BY ${orderSql}
            </when>
            <otherwise>
                ORDER BY   effectiveDate desc
            </otherwise>
        </choose>


        </sqlMapper>
    </sqlMappers>


</report>


